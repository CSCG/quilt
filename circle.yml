machine:

  xcode:
    version: 9.0

  environment:
    #TEST_REGISTRY: false
    QPYVER: 3.5
    QUILT_SERVER_CONFIG: dev_config.py
    FLASK_APP: quilt_server
    FLASK_DEBUG: 1
    INSTALL_COMPILER: pip install 'tables' ./compiler --user
    TEST_COMPILER: "python -m pytest compiler"

  pre:
    - curl -o mconda.sh https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh
    - chmod +x mconda.sh
    - ./mconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH" && echo $PATH
    - $HOME/miniconda/bin/conda search "^python$"
    - |
      for version in 2.7.10 3.4.1 3.5.1 3.6.1;
      do
        export PATH="$HOME/miniconda/bin:$PATH"  && conda create --yes -n quilt_env27 python=2.7.10 pip;
      done
    #- export PATH="$HOME/miniconda/bin:$PATH"  && conda create --yes -n quilt_env34 python=3.4.1 pip
    #- export PATH="$HOME/miniconda/bin:$PATH"  && conda create --yes -n quilt_env35 python=3.5.1 pip
    #- export PATH="$HOME/miniconda/bin:$PATH"  && conda create --yes -n quilt_env36 python=3.6.1 pip

dependencies:

  post:
    - echo -r "Installing dependency"
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env && pip install pytest --user && python --version 
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env27 && pip install 'tables' ./compiler --user && source deactivate quilt_env27
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env34 && pip install 'tables' ./compiler --user && source deactivate quilt_env34
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env35 && pip install 'tables' ./compiler --user && source deactivate quilt_env35
    - for version in 2.7.10 3.4.1 3.5.1 3.6.1
      do
        export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env{{ version }} && python --version && source deactivate quilt_env{{version}}
      done
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env{{ version }} && python --version && source deactivate quilt_env{{version}}
        
    #- export PATH="$HOME/miniconda/bin:$PATH" && pip install 'tables' ./compiler --user
    #- if [[ "$TEST_REGISTRY" = "true" ]] ; then export PATH="$HOME/miniconda/bin:$PATH" && pip install -r registry/requirements.txt --user  && pip install registry --user ; fi

test:
  override:
    - echo -r "Running Compiler/Registry Test with $(python --version)"
    #- export PATH="$HOME/miniconda/bin:$PATH" && source activate quilt_env27 && $TEST_COMPILER && source deactivate quilt_env27
    #- export PATH="$HOME/miniconda/bin:$PATH" && python -m pytest compiler
    #- if [[ "$TEST_REGISTRY" = "true" ]] ; then export PATH="$HOME/miniconda/bin:$PATH" && python -m pytest ./registry ; fi
